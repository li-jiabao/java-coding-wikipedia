---
title: 应用层
author: lijiabao
date: 2021-06-09 23:40:24
category: 计算机网络
categories: 计算机网络
tags: 计算机网络

---

介绍计算机网络中的应用层

# 应用层

## 1 网络应用体系结构

### 1.1 客户端-服务端结构（C/S）

服务端：（缺点就是服务器需要一直供电维护，开销比较大，资源浪费）

- 全天全时提供服务
- 拥有永久性的访问地址/域名
- 利用大量的服务器实现扩展性

客户端：

- 可以和服务端进行通信，使用服务端提供的服务
- 间歇性接入网络
- 可能使用动态IP
- 不会与其他客户机直接通信

### 1.2 P2P结构

- 没有永远在线的服务器
- 端系统/结点之间可以相互通信
- 端系统/结点间歇性接入网络
- 结点IP地址可能会改变

优缺点：

- 优点是灵活，高度可伸缩
- 缺点是难于管理

### 1.3 两个结构结合

将二者结构结合，能减少两者结构的缺点，但是也不能完全避免所有的缺点

- 文件的传输使用P2P结构
- 文件的搜索采用C/S结构

## 2 网络应用进程之间的通信

**进程**：主机上运行的程序

同一主机之间的进程通信：**进程通信机制**和**操作系统**来提供的

不同主机之间的进程通信：通过**信息交换**

### 2.1 套接字（Socket）

不同的主机之间的进程通信：通过Socket发送和接受消息实现

这个通信过程类似于寄信：

发送方借助传输基础设施将消息传送到接受方所在的主机，以及程序所在的进程，然后接收方从该进程获取信息

**传输基础设施向进程提供API**：

- 传输协议的选择
- 参数的设置

### 2.2 进程寻址

不同主机上的进程间通信，那么每个进程必须拥有标识符

寻址主机：利用IP

但是光利用IP并不能找到主机上的进程，因此还需为主机上每个需要通信的进程分配一个端口号，常见的几种端口号：

- HTTP server：80
- Mail server：25
- mysql server：3367

进程标识符：**IP地址+port端口号**

### 2.3 应用层协议

网络应用应该遵循应用层协议

公开协议：

- RFC定义
- HTTP、SMTP、DNS、FTP...

私有协议：

- 多数P2P文件共享应用

### 2.4 应用层协议内容

消息类型：

- 请求消息
- 响应消息

消息的语法格式：

- 消息中有哪些字段？
- 字段如何描述

消息的语义：

- 字段信息的含义

规则（时序）：

- 进程何时发送/响应消息
- 进程怎么发送/响应消息

## 3 网络应用对传输服务的需求

### 3.1 对传输服务的需求

- 数据丢失/可靠性
  1. 有些网络应用能够容忍一定的数据丢失：网路电话
  2. 有些应用要求100%可靠的数据传输：文件传输，telnet
- 时间/延迟
  1. 有些应用在延迟足够低时才有效
  2. 网络电话/网络游戏
- 带宽
  1. 有些应用需要带宽达到最低要求时才有效：网络视频
  2. 某些应用能够适应任何带宽：email

典型网络应用的需求：

| 应用           | 数据丢失 | 带宽       | 时间敏感性 |
| -------------- | -------- | ---------- | ---------- |
| 文件传输       | 不能丢失 | 弹性要求   | 无         |
| email          | 不能丢失 | 弹性要求   | 无         |
| 网络文件       | 不能丢失 | 弹性要求   | 无         |
| 实时视频/音频  | 允许     | 有带宽要求 | 有         |
| 存储的音频视频 | 允许     | 有带宽要求 | 有         |
| 交互式游戏     | 允许     | 较小的要求 | 有         |
| 实时通讯       | 不能丢失 | 弹性要求   | 可有可无   |

### 3.2 Internet提供的传输服务

#### 3.2.1 TCP服务

- 面向连接：客户机和服务端进程需要建立连接
- 可靠的传输：不会出现数据丢失的情况
- 流量控制：发送方不会发送速度过快，超过接收方的处理能力
- 拥塞控制：当网络负载过重时能够限制发送方的发送速度
- 不能提供时间/延迟保障
- 不能提供最小带宽保障

#### 3.2.2 UDP服务

- 无连接
- 不可靠的数据传输
- 不提供
  - 可靠性保障
  - 流量控制
  - 拥塞控制
  - 延迟保障
  - 带宽保障

## 4 网络应用

应用层中相关的一些应用有：Web/HTTP、FTP文件传输、DNS域名服务系统、SMTP邮件服务等

### 4.1 Web/HTTP

HTTP：超文本传输协议，是web应用的核心，由客户端程序和服务器程序实现，两个程序运行在不同的端系统，交换HTTP报文来进行通信会话。HTTP协议主要是定义了报文的结构以及报文交换的方法（客户如何向服务器请求Web页面，服务器如何向客户传输Web页面）。

HTTP通信就是客户向服务器发出一个HTTP请求，然后服务器接受到请求信息之后，根据请求携带的信息给出客户需要的资源，然后将这个资源通过HTTP响应发送给客户。HTTP使用TCP作为它在运输层上的运输协议，HTTP客户首先发起TCP连接服务器，连接建立好之后就可以通过Socket访问TCP，然后就可以进行报文的传输通信。

HTTP是无状态协议，因为HTTP服务器并不保存关于客户的任何信息。HTTP使用的网络应用体系结构是客户-服务器的结构，web服务器是具有固定IP的，用来接受来自不同浏览器的请求。

HTTP使用的TCP连接方式：既可以使用非持续连接，也可以使用持续连接，默认采用持续连接

#### 4.1.1 非持续连接

**非持续连接**：对每一个请求响应都经过一个单独的TCP连接来进行。

HTTP非持续连接的过程：

- HTTP在端口号80发送到服务器www.baidu.com的TCP连接，客户端和服务器端分别有一个套接字和该连接关联通信
- HTTP客户经过客户端的套接字向服务器发送一个HTTP请求报文
- 服务器通过它的套接字接受请求报文，然后根据客户请求信息找到请求的资源，并在响应报文中将需要的资源封装进来，在通过套接字向客户端发送响应报文
- HTTP服务器通知TCP断开这个TCP连接（需要等客户端确定响应报文已经接受完毕之后才会中断）
- HTTP客户端接受响应报文信息，TCP连接关闭。一般响应报文封装的是HTML文件，客户从该报文中提取出该文件，然后对该文件进行处理展示
- 对于其他的每个请求，都需要进行上面的步骤，因为非持续连接的TCP连接只传输一个HTTP请求和响应报文

非持续连接的 缺点：

- 对于每一个请求响应，都需要打开新的TCP连接，给服务器带来很大的负担（需要分配TCP缓冲区和保持TCP变量，而服务器的请求数量往往很大）
- 交付时延大，经受了两倍RTT（往返时间：分组从客户到服务器再返回客户所花费的时间）时延，一个用于创建TCP，另外一个用来请求和发送对象

#### 4.1.2 持续连接

**持续连接**：对于每一个请求响应都是经过相同的TCP连接来进行的

持续连接的过程：

- 持续连接和非持续连接的区别就是：在服务器发送了响应报文之后，并不通知TCP连接关闭，而是保持TCP连接打开，后续的请求和响应都可以继续通过该TCP连接进行传输

持续连接解决了上面的非持续连接的缺点，减少了一个RTT（TCP连接需要的往返时间），并且减少了同一个客户请求所需要创建的TCP连接数量，减少了开销。

#### 4.1.3 HTTP报文格式

##### 4.1.3.1 请求报文

格式：

请求行：HTTP请求报文的第一行，方法字段（GET、POST、HEAD、DELETE、PUT）、URL字段、HTTP版本字段

首部行：请求行之后的行，请求头

请求体：请求头之后的行

![image-20210611153831311](https://i.loli.net/2021/06/11/vFVz2hAmi6yRbeg.png)

##### 4.1.3.2 响应报文

**格式**

状态行：请求报文的第一行，初始状态行，协议版本字段、状态码、相应的状态信息

首部行：响应头，状态行之后的后续行

实体行：请求的对象

![image-20210611153926368](https://i.loli.net/2021/06/11/WPgjZGkCH5T1sFd.png)

#### 4.1.4 Cookie

因为HTTP是无状态的，因此web站点并不能够识别用户，也不能针对用户进行某些操作（限制访问或者返回之前用户访问的状态），为此HTTP使用了cookie技术来实现站点对用户进行跟踪

##### 4.1.4.1 cookie的技术组件

1. HTTP响应报文中有一个cookie的首部行
2. HTTP请求报文中有一个cookie的首部行
3. 用户端系统中保留了一个cookie文件，并交由用户的浏览器进行管理
4. web站点的后端数据库中保存了cookie信息

![image-20210611155613333](https://i.loli.net/2021/06/11/oLdKvSA41WxF6R3.png)

#### 4.1.5 Web缓存

**Web缓存器**：又可叫做代理服务器，可以代表初始web服务器来满足HTTP请求的网络实体，缓存器有磁盘存储空间，用来保存最近请求的资源副本。通过配置用户浏览器，让用户的所有HTTP请求首先指向web缓存器，会出现以下的情况：

- 首先通过建立到web缓存器的TCP连接，并发出HTTP请求，如果请求的资源在缓存器中存在，立马返回该资源
- 如果请求的资源在缓存器中不存在，它就建立一个和服务器之间的TCP连接，发送HTTP请求向服务器请求资源，然后将请求到的资源在缓存器中保存一份，再将客户请求的资源通过HTTP响应传递给客户

部署web缓存器的原因和优点：

- 可以减少客户请求的响应时间，特别是客户端和服务器之间的瓶颈带宽低于客户端和缓存器之间的瓶颈带宽时
- web缓存器可以大大减少一个机构的接入链路到因特网的通信量，减少了通信量，就可以不急于增加带宽。

#### 4.1.6 条件GET方法

web缓存器可以减少响应时间，但是同时缓存器也带来另外一个问题，缓存器中的对象可能不是最新的内容。HTTP中有一个可以解决这个问题的机制：条件GET方法，使用这个方法 需要使用的是GET方法，且请求报文中包含If-Modified-Since加入需要判断自什么时候开始有没有发生改变的首部行

### 4.2 FTP文件传输

FTP：用户首先提供远程主机的主机名，然后让本地主机和远程FTP服务器创建一个TCP连接，接着用户提供用户的标识和口令，一旦验证通过，就可以在二者之间利用TCP连接来传输文件

HTTP和FTP都是基于TCP传输的协议，但是FTP使用了两个并行的TCP连接来传输文件，一个是**控制连接**（端口号21），用来传输控制信息（用户标识，口令、改变远程目录的命令以及存放获取的命令），另外一个是**数据连接**（端口号20），用来实际发送一个文件。FTP是带外传输控制信息，HTTP是带内发送控制信息

FTP首先创建一个控制连接，客户端通过该控制连接发送用户标识和口令，验证通过之后便可以发送命令。然后FTP服务器接受到指令之后，便和客户端建立一个数据连接的TCP连接，等到命令执行完毕之后便关闭连接，之后再接收到新的指令再创建新的连接。

对于FTP服务器，必须在整个会话保持控制连接（持续连接），对于数据连接（非持续连接）不需要一直保持，执行指令的时候创建。FTP服务器必须在整个会话期间保留用户的状态

### 4.3 SMTP邮件

![image-20210611215110017](https://i.loli.net/2021/06/11/S4MIzvTWKGB2YA7.png)

SMTP邮件协议和HTTP还是很相似的，都是建立在TCP上的持续连接，但是HTTP是从服务器获取数据，属于**拉协议**，而SMTP是从客户端向服务器发送数据，属于**推协议**。然后SMTP要求每个报文使用7比特的ASCII码格式（由于传输能力不足），而 HTTP没有这种限制

#### 4.3.1 邮件报文格式

```
From: ...
首部
To: ...

Subject: ...
```

#### 4.3.2 邮件访问协议

##### 4.3.2.1 POP3

POP3按照三个阶段进行工作：特许、事务处理以及更新。

##### 4.3.2.2 IMAP

IMAP把每个报文与一个文件夹联系起来，当报文第一次到到达服务器时，它与收件人的INBOX文件夹相关联，收件人则能够把邮件移动到一个新的用户创建的文件夹中，阅读和删除邮件。IMAP为用户提供了创建文件夹以及移动邮件的命令，同时IMAP还给用户提供了远程文件夹中查询邮件的命令

##### 4.3.2.3 基于web的邮件协议

访问邮件服务器中的报文时，从服务器发送到浏览器中是通过HTTP而不是POP3或者IMAP协议，但是在邮件服务器之间传输还是使用的SMTP

### 4.4 DNS域名服务系统

识别主机有两种方式：主机名或者IP地址，但是人类更易记忆的是主机名的标识方法，而路由器则喜欢定长的IP地址，为了解决二者之间的不和，创建了一个域名服务系统（DNS），用来进行IP和主机名之间的映射和转换

- 一个由分层的DNS服务器实现的分布式数据库
- 一个能够查询分布式数据库的应用层协议，DNS服务器通常是运行BIND软件的UNIX及其
- DNS协议运行在UDP上，使用53号端口

DNS通常是由其他应用层协议所使用的，如HTTP，SMTP和FTP，将用户提供的主机名解析未IP地址。为了通过使用主机名来访问到主机名对应的IP地址，需要进行：

- 同一台用户主机上需要运行着DNS应用的客户端
- 浏览器抽取主机名，并将这个主机名传给DNS应用的客户端
- DNS客户端向DNS服务器发送一个包含主机名的请求
- DNS服务器传送主机名对应的IP地址给客户端
- 接收到IP地址之后便可以利用该IP地址创建TCP连接

DNS使用给互联网应用带来了额外的时延，有时候这个时延还很大，但是往往想要的IP地址通常就缓存在一个附近的DNS服务器中，着有助于减少DNS的网络流量和DNS的平均时延

除了提供主机名和IP地址的转换之外，DNS还提供了一些重要的服务：

- 主机别名：有些复杂主机名的主机可能拥有一个或者多个别名，别名更加容易记忆，长度小。DNS往往可以利用主机别名获取规范的主机名以及主机对应的IP地址
- 邮件服务器别名：是为了更好的记忆邮件服务器标识
- 负载分配：DNS可以在繁忙的服务器之间进行负载分配，对于多个主机对应的一个规范主机名，DNS可以根据负载来返回该主机名对应的IP地址中负载较小的IP地址，从而减少服务器的负担

![image-20210611223841328](https://i.loli.net/2021/06/11/hsKLDkRCmUlM5P6.png)

DNS查询：

- 迭代查询：向上一层的DNS服务器查询接下来需要查询的服务器的IP，然后不断由本地服务器来发起请求
- 递归查询：将域名解析的任务交给联系的服务器

### 4.5 P2P应用

